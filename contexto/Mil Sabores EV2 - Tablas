-- ==================================================================== --
-- ====================== Pasteleria Mil Sabores ====================== --
-- ===================== Evaluación Parcial N° 2 ====================== --
-- ==================================================================== --

-- === Integrantes === --
-- Nicole Chavez
-- Nicolás Barra

-- =========== Eliminacion de Tablas Existentes =========== --
-- Se eliminan las tablas en el orden inverso a su creacion
-- para manejar las dependencias de llaves foraneas.
DROP TABLE PEDIDOS_DETALLES 	CASCADE CONSTRAINTS;
DROP TABLE PEDIDOS 				CASCADE CONSTRAINTS;
DROP TABLE PRODUCTOS 			CASCADE CONSTRAINTS;
DROP TABLE CLIENTES 			CASCADE CONSTRAINTS;
DROP TABLE PEDIDOS_ESTADOS 		CASCADE CONSTRAINTS;
DROP TABLE CATEGORIAS 			CASCADE CONSTRAINTS;

-- Tablas de Auditoría
DROP TABLE CLIENTES_AUDITORIA 	CASCADE CONSTRAINTS;
DROP TABLE AUDITORIA_SISTEMA 	CASCADE CONSTRAINTS;

-- Tablas de Reportería
DROP TABLE REPORTE_VENTAS_DIARIAS 		CASCADE CONSTRAINTS;
DROP TABLE REPORTE_GANANCIAS_MENSUALES 	CASCADE CONSTRAINTS;
DROP TABLE REPORTE_STOCK_CRITICO 		CASCADE CONSTRAINTS;


-- =========== Tablas Base =========== --

-- TABLA CATEGORIAS: Almacena las categorías, usando un 'slug' para uso interno (web) y un 'nombre' para visualización.
CREATE TABLE CATEGORIAS (
    id_categoria 	NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    slug 			VARCHAR2(100) NOT NULL UNIQUE,
    nombre 			VARCHAR2(100) NOT NULL,
    icono 			VARCHAR2(50)
);

-- TABLA CLIENTES: Contiene la información detallada de los clientes.
CREATE TABLE CLIENTES (
    id_cliente 			NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre 				VARCHAR2(50) NOT NULL,
    apellido_paterno 	VARCHAR2(50) NOT NULL,
    apellido_materno 	VARCHAR2(50),
    correo 				VARCHAR2(100) NOT NULL UNIQUE,
    direccion 			VARCHAR2(255),
    fecha_nacimiento 	DATE,
    telefono 			VARCHAR2(15),
    fecha_creacion 		DATE DEFAULT SYSDATE
);

-- TABLA PRODUCTOS: Lista todos los productos disponibles para la venta con sus precios y stock.
CREATE TABLE PRODUCTOS (
    id_producto 			NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_categoria 			NUMBER NOT NULL,
    nombre 					VARCHAR2(100) NOT NULL,
    precio 					NUMBER(10, 2) NOT NULL,
    stock 					NUMBER(5) DEFAULT 0,
    descripcion_corta 		VARCHAR2(255),
    descripcion_detallada 	CLOB,
    imagen 					VARCHAR2(255),
    
    CONSTRAINT fk_prod_cat FOREIGN KEY (id_categoria) REFERENCES CATEGORIAS(id_categoria)
);

-- TABLA PEDIDOS_ESTADOS: Una tabla para manejar los estados de los pedidos de forma normalizada.
CREATE TABLE PEDIDOS_ESTADOS (
    id_estado 	NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    estado 		VARCHAR2(50) NOT NULL UNIQUE
);

-- TABLA PEDIDOS: Registra cada orden de compra, con una llave foránea a PEDIDOS_ESTADOS.
CREATE TABLE PEDIDOS (
    id_pedido 		NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_cliente 		NUMBER NOT NULL,
    id_estado 		NUMBER NOT NULL, 
    fecha_pedido 	DATE NOT NULL,
    total 			NUMBER(10, 2) NOT NULL,
    
    CONSTRAINT fk_pedido_cliente FOREIGN KEY (id_cliente) REFERENCES CLIENTES(id_cliente),
    CONSTRAINT fk_pedido_estado FOREIGN KEY (id_estado) REFERENCES PEDIDOS_ESTADOS(id_estado)
);

-- TABLA PEDIDOS_DETALLES: Actúa como un carrito de compra, vinculando productos a pedidos con sus cantidades.
CREATE TABLE PEDIDOS_DETALLES (
    id_detalle 	NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_pedido 	NUMBER NOT NULL,
    id_producto NUMBER NOT NULL,
    cantidad 	NUMBER(5) NOT NULL,
    
    CONSTRAINT fk_peddet_pedido FOREIGN KEY (id_pedido) REFERENCES PEDIDOS(id_pedido),
    CONSTRAINT fk_peddet_prod FOREIGN KEY (id_producto) REFERENCES PRODUCTOS(id_producto),
    CONSTRAINT unique_detalle UNIQUE (id_pedido, id_producto)
);

-- =========== Tablas de Auditoría =========== --

-- TABLA: CLIENTES_AUDITORIA: Almacena un registro de auditoría de los cambios (inserciones, actualizaciones) realizados en la tabla CLIENTES.
CREATE TABLE CLIENTES_AUDITORIA (
    id_registro 		NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_cliente_afectado NUMBER NOT NULL,
    accion 				VARCHAR2(10) NOT NULL,
    fecha_accion 		TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    usuario_bd 			VARCHAR2(30) NOT NULL
);

-- (NUEVA) TABLA: AUDITORIA_SISTEMA: Almacena un registro de auditoría de alto nivel, enfocado en eventos a nivel de sentencia.
CREATE TABLE AUDITORIA_SISTEMA (
    id_registro     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    usuario_bd      VARCHAR2(100) NOT NULL,
    evento          VARCHAR2(50) NOT NULL,
    tabla_afectada  VARCHAR2(50) NOT NULL,
    fecha_evento    TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL
);

-- =========== Tablas de Reportería =========== --

-- (NUEVA) TABLA: REPORTE_VENTAS_DIARIAS: Almacena el resumen de ventas por producto para cada día.
CREATE TABLE REPORTE_VENTAS_DIARIAS (
    id_reporte      	NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    fecha_reporte   	DATE NOT NULL,
    id_producto     	NUMBER NOT NULL,
    cantidad_total  	NUMBER NOT NULL,
    subtotal_calculado 	NUMBER(12, 2) NOT NULL,
    CONSTRAINT fk_reporte_prod FOREIGN KEY (id_producto) REFERENCES PRODUCTOS(id_producto)
);

-- (NUEVA) TABLA: REPORTE_GANANCIAS_MENSUALES: Almacena el total de ganancias consolidadas por mes y año.
CREATE TABLE REPORTE_GANANCIAS_MENSUALES (
    id_reporte_mensual NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    anio_reporte       NUMBER(4) NOT NULL,
    mes_reporte        NUMBER(2) NOT NULL,
    ganancia_total     NUMBER(15, 2) NOT NULL,
    CONSTRAINT uq_reporte_mes UNIQUE (anio_reporte, mes_reporte)
);

-- (NUEVA) TABLA: REPORTE_STOCK_CRITICO: Almacena productos que han caído bajo un umbral de stock.
CREATE TABLE REPORTE_STOCK_CRITICO (
    id_reporte_stock    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    fecha_reporte       DATE DEFAULT SYSDATE,
    id_producto         NUMBER NOT NULL,
    stock_actual        NUMBER NOT NULL,
    CONSTRAINT fk_reporte_stock_prod FOREIGN KEY (id_producto) REFERENCES PRODUCTOS(id_producto)
);


-- =========== Inserts de Datos Base =========== --

-- Inserts para la tabla CATEGORIAS
INSERT INTO CATEGORIAS (slug, nombre, icono) VALUES ('tortas-cuadradas', 'Tortas Cuadradas', 'fas fa-square');
INSERT INTO CATEGORIAS (slug, nombre, icono) VALUES ('tortas-circulares', 'Tortas Circulares', 'fas fa-circle');
INSERT INTO CATEGORIAS (slug, nombre, icono) VALUES ('postres-individuales', 'Postres Individuales', 'fas fa-cookie-bite');
INSERT INTO CATEGORIAS (slug, nombre, icono) VALUES ('productos-sin-azucar', 'Productos Sin Azúcar', 'fas fa-heart');
INSERT INTO CATEGORIAS (slug, nombre, icono) VALUES ('pasteleria-tradicional', 'Pastelería Tradicional', 'fas fa-home');
INSERT INTO CATEGORIAS (slug, nombre, icono) VALUES ('productos-sin-gluten', 'Productos Sin Gluten', 'fas fa-leaf');
INSERT INTO CATEGORIAS (slug, nombre, icono) VALUES ('productos-veganos', 'Productos Veganos', 'fas fa-seedling');
INSERT INTO CATEGORIAS (slug, nombre, icono) VALUES ('tortas-especiales', 'Tortas Especiales', 'fas fa-star');

-- Inserts para la tabla PEDIDOS_ESTADOS
INSERT INTO PEDIDOS_ESTADOS (estado) VALUES ('Pendiente');
INSERT INTO PEDIDOS_ESTADOS (estado) VALUES ('En Preparacion');
INSERT INTO PEDIDOS_ESTADOS (estado) VALUES ('Enviado');
INSERT INTO PEDIDOS_ESTADOS (estado) VALUES ('Entregado');
INSERT INTO PEDIDOS_ESTADOS (estado) VALUES ('Cancelado');

-- Inserts para la tabla PRODUCTOS
-- (Se mantiene el script de inserción de productos que ya depuramos)
INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'tortas-cuadradas'), 'Torta Cuadrada de Chocolate', 45990, 100, 'Deliciosa torta de chocolate con relleno de crema.', 'Exquisita torta de chocolate premium elaborada con los mejores ingredientes. Capas de bizcocho de chocolate esponjoso, relleno de crema de chocolate belga y decoración artesanal con virutas de chocolate. Perfecta para celebraciones especiales, cumpleaños y eventos importantes. Cada bocado es una experiencia de sabor inolvidable.', 'https://delicakesysnacks.com/wp-content/uploads/2025/01/vitxekmdoeio3sgmh5dr-1.webp');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'tortas-cuadradas'), 'Torta Cuadrada de Frutas', 22990, 100, 'Torta fresca con frutas de temporada y crema chantilly.', 'Hermosa torta cuadrada decorada con una selección de frutas frescas de temporada como fresas, kiwis, duraznos y arándanos. Base de bizcocho esponjoso de vainilla, relleno de crema chantilly casera y decoración artesanal con frutas frescas. Perfecta para celebraciones de verano, cumpleaños y eventos al aire libre. Cada porción es una explosión de sabores frescos y naturales.', 'https://thumbs.dreamstime.com/b/este-delicioso-pastel-de-fruta-cuadrada-con-capas-esponja-ligera-y-crema-delicada-adornado-generosidad-est%C3%A1-decorado-una-gran-398214730.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'tortas-circulares'), 'Torta Circular de Vainilla', 18990, 100, 'Torta tradicional de vainilla con buttercream y frutas frescas.', 'Clásica torta circular de vainilla, elaborada con extracto de vainilla natural y decorada con buttercream suave. Capas de bizcocho esponjoso de vainilla, relleno de crema de vainilla y decoración elegante con frutas frescas de temporada. Un postre atemporal que nunca pasa de moda, perfecto para cualquier celebración.', 'https://wiltonenespanol.com/wp-content/uploads/2017/02/pastel-de-vainilla.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'tortas-circulares'), 'Torta Circular de Manjar', 15990, 100, 'Torta circular con manjar casero y decoración elegante.', 'Exquisita torta circular de manjar casero, elaborada con la receta tradicional chilena. Capas de bizcocho esponjoso, relleno generoso de manjar casero y decoración elegante con nueces y almendras. Un clásico de la repostería chilena que evoca los sabores de la infancia. Perfecta para celebraciones familiares y ocasiones especiales.', 'https://www.elingenio.cl/productos/bizcocho-manjar-lucuma.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORias WHERE slug = 'tortas-circulares'), 'Torta Circular de Frutilla', 19990, 100, 'Torta circular de frutillas frescas con crema chantilly.', 'Deliciosa torta circular de frutillas frescas, elaborada con las mejores frutillas de temporada. Base de bizcocho esponjoso de vainilla, relleno de crema chantilly casera y decorada con frutillas frescas enteras y en rodajas. Un postre fresco y elegante que combina la dulzura natural de las frutillas con la suavidad de la crema. Perfecta para celebraciones de primavera y verano, cumpleaños y eventos especiales.', 'https://www.annarecetasfaciles.com/files/tarta-de-fresas-y-nata-3.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'postres-individuales'), 'Mousse de Chocolate', 5990, 100, 'Delicioso mousse de chocolate con decoración de frutas.', 'Exquisito mousse de chocolate intenso, elaborado con chocolate premium y crema fresca. Textura suave y aterciopelada que se derrite en el paladar. Decorado con frutas frescas de temporada y virutas de chocolate. Perfecto como postre individual o para compartir en ocasiones especiales. Una experiencia de sabor que deleitará a los amantes del chocolate.', 'https://images.aws.nestle.recipes/original/2024_10_18T11_53_16_badun_images.badun.es_4ed41e942636_mousse_de_chocolate_intenso.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'postres-individuales'), 'Tiramisú Clásico', 7990, 100, 'Tiramisú tradicional italiano con café y mascarpone.', 'Auténtico tiramisú italiano, elaborado siguiendo la receta tradicional. Capas de bizcocho savoiardi empapado en café espresso, crema de mascarpone suave y espolvoreado con cacao en polvo. Un postre elegante y sofisticado que transporta a las cafeterías de Italia. Perfecto para los amantes del café y la repostería italiana.', 'https://www.kingarthurbaking.com/sites/default/files/2023-03/Tiramisu_1426.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'productos-sin-azucar'), 'Torta Sin Azúcar de Naranja', 25990, 100, 'Torta saludable sin azúcar con sabor a naranja natural.', 'Deliciosa torta de naranja sin azúcar, elaborada con naranjas frescas y edulcorantes naturales. Perfecta para personas con diabetes o que buscan opciones más saludables. Base de bizcocho esponjoso de naranja, relleno de crema de naranja natural y decoración con gajos de naranja fresca. Un postre refrescante y saludable que no compromete el sabor.', 'https://santaisabel.vtexassets.com/arquivos/ids/447848-900-900?width=900&&height=900&aspect=true');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'productos-sin-azucar'), 'Cheesecake de Maracuyá Sin Azúcar', 12990, 100, 'Cheesecake de maracuyá sin azúcar, saludable y delicioso.', 'Delicioso cheesecake de maracuyá sin azúcar, perfecto para quienes buscan un postre saludable sin comprometer el sabor. Elaborado con edulcorantes naturales como stevia y la frescura única del maracuyá natural. Base de galletas integrales sin azúcar, crema de queso suave y topping de maracuyá fresco. Ideal para personas con diabetes, dietas bajas en carbohidratos o simplemente para quienes prefieren opciones más saludables sin sacrificar el sabor.', 'https://bechef.cl/wp-content/uploads/2022/02/CCMM-1.png');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'pasteleria-tradicional'), 'Empanada de Manzana', 1890, 100, 'Empanada tradicional de manzana con canela y azúcar.', 'Deliciosa empanada de manzana casera, elaborada con masa fresca y relleno de manzanas cortadas en cubos con canela, azúcar y un toque de limón. Horneada hasta obtener una textura dorada y crujiente. Un clásico de la repostería chilena que combina perfectamente con una taza de té o café. Ideal para la hora del té o como postre ligero.', 'https://cocinachilena.cl/wp-content/uploads/2012/11/empanadas-manzana-3-scaled.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'pasteleria-tradicional'), 'Tarta de Santiago', 11990, 100, 'Tarta tradicional española con almendras y limón.', 'Auténtica Tarta de Santiago, el postre más emblemático de Galicia. Elaborada con almendras molidas, huevos, azúcar y un toque de limón. Decorada con la cruz de Santiago en azúcar glass. Una tarta sin harina, perfecta para celíacos, con una textura húmeda y un sabor intenso a almendras. Un clásico de la repostería española que conquista paladares.', 'https://recetasdecocina.elmundo.es/wp-content/uploads/2025/03/tarta-de-santiago.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'productos-sin-gluten'), 'Brownie Sin Gluten', 2990, 100, 'Brownie delicioso sin gluten con chocolate premium.', 'Exquisito brownie sin gluten elaborado con chocolate premium y harina de arroz. Textura húmeda y densa en el centro, con una corteza crujiente en la superficie. Perfecto para personas celíacas o que siguen una dieta sin gluten. Decorado con nueces y chips de chocolate. Un postre que no compromete el sabor ni la textura tradicional del brownie.', 'https://www.justspices.es/media/recipe/brownie-chocolate.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'productos-sin-gluten'), 'Pan Sin Gluten', 3590, 100, 'Pan artesanal sin gluten con semillas y frutos secos.', 'Pan artesanal sin gluten elaborado con una mezcla de harinas especiales, semillas de girasol, chía y sésamo, además de frutos secos como nueces y almendras. Textura esponjosa y sabor natural. Perfecto para el desayuno o acompañar cualquier comida. Ideal para personas celíacas o que buscan opciones más saludables sin comprometer el sabor.', 'https://imag.bonviveur.com/pan-sin-gluten.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'productos-veganos'), 'Torta Vegana de Chocolate', 22990, 100, 'Torta de chocolate 100% vegana con ingredientes naturales.', 'Exquisita torta de chocolate 100% vegana, elaborada sin productos de origen animal. Utiliza chocolate vegano, leche de almendras, azúcar de coco y harina integral. Decorada con crema de coco y frutas frescas. Perfecta para veganos, vegetarianos o cualquier persona que busque opciones más saludables y sostenibles sin comprometer el sabor delicioso del chocolate.', 'https://www.lagloriavegana.com/wp-content/uploads/2020/08/Bizcocho-muerte-por-chocolate-1280x1280.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'productos-veganos'), 'Galletas Veganas de Avena', 890, 100, 'Galletas saludables de avena con pasas y canela.', 'Deliciosas galletas veganas de avena, elaboradas con avena integral, pasas, canela y endulzadas con azúcar de coco. Sin huevos, leche ni mantequilla. Perfectas para el desayuno, merienda o como snack saludable. Textura crujiente por fuera y suave por dentro. Ideales para veganos, vegetarianos o cualquier persona que busque opciones más saludables y nutritivas.', 'https://luciacomparada.com/wp-content/uploads/2024/01/galletas-de-avena-veganas-05.jpg');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'tortas-especiales'), 'Torta Especial de Cumpleaños', 29990, 100, 'Torta personalizada para cumpleaños con decoración especial.', 'Torta especial de cumpleaños personalizada según tus gustos y preferencias. Elaborada con los mejores ingredientes y decorada con crema, frutas frescas, chocolates y elementos decorativos temáticos. Perfecta para hacer de tu cumpleaños un día inolvidable. Incluye decoración personalizada con el nombre del cumpleañero y velas. Una experiencia única que combina sabor excepcional con presentación espectacular.', 'assets/images/torta-cumpleaños.webp');

INSERT INTO PRODUCTOS (id_categoria, nombre, precio, stock, descripcion_corta, descripcion_detallada, imagen)
VALUES ((SELECT id_categoria FROM CATEGORIAS WHERE slug = 'tortas-especiales'), 'Torta Especial de Boda', 79990, 100, 'Torta elegante para bodas con decoración premium.', 'Exquisita torta de boda elaborada con la máxima elegancia y sofisticación. Diseño personalizado según el estilo de la boda, con decoración artesanal que incluye flores comestibles, detalles en fondant y acabados de lujo. Perfecta para hacer de tu día especial un momento inolvidable. Cada detalle está cuidadosamente elaborado para crear una obra de arte comestible que refleje la personalidad de los novios.', 'https://bodasyweddings.com/wp-content/uploads/2015/04/Si-prefieres-un-diseno-simple-hazlo-inolvidable.jpg');